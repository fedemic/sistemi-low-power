\documentclass[11pt,  english, makeidx, a4paper, titlepage, oneside]{book}

% Packages
\usepackage{graphicx} % Usato per \includegraphics 
\usepackage{titlesec} % Usato per modificare/rimuovere le scritte Capitolo 1,2 ecc
\usepackage{textcomp} % Usaato per caratteri speciali
\usepackage{listings} % Usato per VHDL
\usepackage{xcolor} % Usato per i colori
\usepackage{amsmath}	% usato per visualizzare e avere comandi sulle equazioni
\usepackage{amssymb} % usato per simboli speciali
\usepackage{booktabs} % usato per gestire le tabelle, multicolonne
\usepackage{chngcntr} 
\counterwithin{figure}{chapter}
%\usepackage[sfdefault]{Roboto}
%\usepackage[T1]{fontenc}

% Impostazioni pagina
\textwidth 16cm % larghezza del testo nella pagina
\textheight 23cm % altezza del testo nella pagina
\topmargin -1cm % spazio in più o in meno dall'alto
\oddsidemargin 0cm % si può spostare il margine dove inizia il testo nella pagina 
\titleformat{\chapter}[display]
{\normalfont\bfseries}{}{0pt}{\Huge} % Rimuove le scritte Capitolo 1,2 ecc
\newenvironment{listato}{\footnotesize} {\normalsize }
\renewcommand{\arraystretch}{1.4} % modifica alteza delle celle in tabella


% inizio del documento
\begin{document}

% pagina iniziale
\begin{titlepage}

	\centerline{\includegraphics[width=3cm]{./img/general/polito.png}}
	\vspace{0.3cm}
	\centerline{\Large{Politecnico di Torino}}
	\vspace{0.3cm}
	\centerline{\Large{III Facoltà di Ingegneria}}
	\vspace{3cm}
	\centerline{\Huge\textbf{Sistemi elettronici a basso consumo}}
	\vspace{1cm}
	\centerline{\LARGE\textbf{Relazioni di laboratorio}}
	\vspace{3cm}
	\centerline{\LARGE{Laurea Magistrale in Ingegneria Elettronica}}
	\vspace{0.3cm}
	\centerline{\LARGE{Orientamento: Sistemi Elettronici}}
	\vspace{3cm}
	\centerline{\Large{Gruppo n. 9}}
	\vspace{2cm}
	\centerline{\Large{Autori:}}
	\vspace{0.3cm}
	\centerline{\Large{Favero Simone, Micelli Federico, Spanna Francesca}}
	
\end{titlepage}

\tableofcontents % imposta l'indice in automatico
\pagebreak % per passare direttamente alla prossima pagina

\chapter{Laboratorio 1 - Power Estimation: probabilistic techniques}

\section{Calcolo di probabilità e attività: porte logiche elementari}

Il primo esercizio consiste nel valutare le probabilità e attività dell'uscita di 
quattro porte logiche elementari: NOT, AND, OR e XOR.
\\\\
\centerline{\includegraphics[width=12cm]{./img/Lab_1/Es_1/Porte.png}}
\\\\
Mentre la probabilità di uscita del gate è definita dalla funzione logica
stessa, la switching activity è valutata allo stesso modo per tutti i casi, 
mediante la seguente formula:
\\\\
	\centerline{$A = 2 \cdot P1 \cdot (1-P1)$}
\\\\
dove $P1$ indica la probabilità che l'uscita assuma valore logico alto.\\\\
Di seguito è riportata l'analisi delle porte logiche richieste, considerando 
ingressi equiprobabili e scorrelati.

\begin{itemize}
	\item \textbf{NOT} \\
	$P(Y=1) = 1 - P(A=1) = 0.5$ \\
	$A(Y) = 0.5$
	\item \textbf{AND} \\
	$P(Y=1) = P(A=1) \cdot P(B=1) = 0.25$ \\
	$A(Y) = 0.375$
	\item \textbf{OR} \\
	$P(Y=1) = 1-((1-P(A=1)) \cdot(1-P(B=1))) = 0.75$ \\
	$A(Y) = 0.375$
	\item \textbf{XOR} \\
	$P(Y=1) = P(A=1) \cdot(1-P(B=1)) + P(B=1) \cdot(1-P(A=1)) = 0.5$ \\
	$A(Y) = 0.5$ 
\end{itemize} 
Simulando il test bench fornito tramite ModelSim, è possibile ottenere un file 
riportante il numero di commutazioni di ogni segnale del circuito durante il 
tempo di simulazione.
\\
Il testbench fornito sfrutta un generatore di numeri casuali per generare gli 
ingressi delle porte, rendendo questi ultimi equiprobabili e statisticamente 
indipendenti.
\\
Sono riportati i seguenti valori:
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|c|} %numero di colonne
 	\hline % tira una riga
 	Tc(CK) & Tc(INV) & Tc(AND) & Tc(OR) & Tc(XOR) \\ 
 	\hline
 	20 & 1 & 0 & 4 & 4 \\ 
 	\hline
 	200 & 43 & 40 & 42 & 44 \\ 
 	\hline
 	2000 & 533 & 418 & 352 & 470 \\
 	\hline
 	20000 & 4916 & 3606 & 3784 & 4876 \\
 	\hline
 	200000 & 49967 & 37834 & 37541 & 49939 \\
 	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
È possibile stimare la switching activity dividendo il numero 
di commutazioni di un nodo per il numero di colpi di clock della
relativa simulazione.
\\
Dal momento che il parametro Tc si riferisce al numero totale di 
commutazioni, il numero di cicli di clock è ottenuto dividendo per due
il parametro Tc(CK).
\\\\
I risultati dei calcoli sono riportati nella seguente tabella. 
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	Tc(CK) & Esw(INV) & Esw(AND) & Esw(OR) & Esw(XOR) \\ 
	\hline
	20 & 0.1 & 0 & 0.4 & 0.4 \\
	\hline
	200 & 0.43 & 0.40 & 0.42 & 0.44 \\
	\hline
	2000 & 0.533 & 0.418 & 0.352 & 0.470 \\
	\hline
	20000 & 0.4916 & 0.3606 & 0.3784 & 0.4876 \\
	\hline
	200000 & 0.4997 & 0.3783 & 0.3754 & 0.4994 \\
	\hline
	\end{tabular}
\end{center}
\vspace{1cm}
Per garantire una migliore visualizzazione dei dati ottenuti 
al variare del tempo di simulazione, sono stati realizzati 
i seguenti grafici.
\\\\
\centerline{\includegraphics[width=8cm]{./img/Lab_1/Es_1/Inverter.png}
            \includegraphics[width=8cm]{./img/Lab_1/Es_1/AND.png}}
\centerline{\includegraphics[width=8cm]{./img/Lab_1/Es_1/XOR.png}
            \includegraphics[width=8cm]{./img/Lab_1/Es_1/OR.png}}
\vspace{0.5cm}
Si osserva che, all'aumentare del tempo di simulazione, la stima 
dell'attività risulta sempre più accurata. In particolare, 
nel caso analizzato, si osserva che per un numero di cicli di clock 
superiore a 10000, i dati simulati sono confrontabili con quelli teorici.
\newpage

\section{Calcolo di probabilità e attività: half adder e full adder} 
Dalle tavole di verità di Half Adder e Full Adder si ottengono le seguenti funzioni:
\begin{itemize}
	\item \textbf{Half adder} \\
	\centerline{S = A XOR B} \\
	\centerline{Cout = A AND B}
	\item \textbf{Full adder} \\
	\centerline{S = A XOR B XOR Cin} \\
	\centerline{Cout = A AND B AND Cin} \\
\end{itemize}
Partendo dalle funzioni logiche che descrivono le uscite è stato possibile ricavare le probabilità
associate alle uscite e le relative attività.
\begin{itemize}
	\item \textbf{Half adder}\\
	\begin{align*}
	P(S=1) &= P(A=1) \cdot ((1-P(B=1)) + P(B=1) \cdot (1-P(A=1))\\\\
	P(Cout=1) & = P(A=1) \cdot P(B=1)\\\\
	A(S) &= 2 \cdot P(S=1) \cdot (1-P(S=1))\\\\
    A(Cout) &= 2 \cdot P(Cout=1) \cdot (1-P(Cout=1)) 
    \end{align*}	
	\item \textbf{Full adder}
	\begin{align*}
	P(S=1) & = P(A=1) \cdot(1-P(B=1)) \cdot (1-P(Cin=1)) + \\ 
	          & + P(B=1) \cdot(1-P(A=1)) \cdot (1-P(Cin=1)) + \\
	          & + P(Cin=1) \cdot (1-P(A=1)) \cdot(1-P(B=1)) + \\
	          & + P(A=1) \cdot P(B=1) \cdot P(Cin=1)\\\\
	 P(Cout=1) & = P(A=1) \cdot P(B=1) \cdot (1-P(Cin=1)) +\\
	 					& + P(Cin=1) \cdot P(A=1) \cdot (1-P(B=1)) +\\
	 					& + P(Cin=1) \cdot P(B=1) \cdot (1-P(A=1)) +\\
	 					& + P(A=1) \cdot P(B=1) \cdot P(Cin=1)\\\\
	 A(S) & = 2 \cdot P(S=1) \cdot (1-P(S=1))\\\\
	A(Cout) & = 2 \cdot P(Cout=1) \cdot (1-P(Cout=1))
	\end{align*}	
\end{itemize} 
I risultati ottenuti sono riportati nella seguente tabella.
\vspace{0.3cm}
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\multicolumn{5}{c}{P(A) = P(B) = 0.5 }\\
	\hline
	  & P(S=1) & A(S) & P(Cout=1) & A(Cout) \\ 
	\hline
	HA & 0.5 & 0.5 & 0.25 & 0.375 \\
	\hline
	FA & 0.5 & 0.5 & 0.5 & 0.5 \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
Sfruttando i risultati ottenuti per il singolo full adder, è stato possibile ottenere le probabilità e le attività di un ripple carry adder avente parallelismo pari a 8 bit.
\\\\\\
\centerline{\includegraphics[width=15cm]{./img/Lab_1/Es_2/RCA_8_bit.png}}
\\\\\\
Per tale analisi sono stati considerati equiprobabili gli ingressi A e B mentre il carry in ingresso al primo full adder è stato fissato a 0.\\
I risultati ottenuti sono riportati nella seguente tabella.
\vspace{0.3cm}
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|c|c|}
\hline
\multicolumn{10}{c}{P(A) = P(B) = 0.5}\\
\hline
 & S7 & S6 & S5 & S4 & S3 & S2 & S1 & S0 & Cout \\
\hline
P(Y=1) & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 & 0.4980 \\
\hline
A(Y) & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 \\
\hline
\end{tabular}
\end{center}
\vspace{0.3cm}
Variando le probabilità associate agli ingressi, in particolare considerando P(A=1) = 0.4 e P(B=1) = 0.6, si ottengono i seguenti risultati.
\vspace{0.3cm}
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|c|c|}
\hline
\multicolumn{10}{c}{P(A) = 0.4 e P(B) = 0.6}\\
\hline
 & S7 & S6 & S5 & S4 & S3 & S2 & S1 & S0 & Cout \\
\hline
P(Y=1) & 0.52 & 0.5104 & 0.5054 & 0.5028 & 0.5015 & 0.5008 & 0.5004 & 0.5002 & 0.4973 \\
\hline
A(Y) & 0.4992 & 0.4998 & 0.4999 & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 & 0.5 \\
\hline
\end{tabular}
\end{center}
\vspace{0.3cm}
È possibile notare come la probabilità delle varie uscite sia funzione delle probabilità degli ingressi.
In particolare, la probabilità delle uscite relative alle somme aumenta. Si nota che ai bit relativi agli stadi iniziali sono associati valori che non si discostano molto dal caso di ingressi equiprobabili mentre i bit più significativi subiscono una variazione più marcata.\\\\
Al fine di avere un riscontro sui dati stimati, sono state effettuate due simulazioni tramite ModelSim: in un primo caso è stato considerato un ritardo limitato alle uscite relative alle somme; successivamente è stato introdotto un ulteriore ritardo anche sul carry in uscita di ogni full adder.
Come descritto precedentemente, il file fornito da Modelsim riporta il numero di commutazioni dei segnali, di conseguenza l'attività è stata calcolata in modo analogo all'esercizio precedente.\\
\vspace{0.3cm}
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|c|c|c|c|}
\hline
 & A(S7) & A(S6) & A(S5) & A(S4) & A(S3) & A(S2) & A(S1) & A(S0) & A(Cout) \\
\hline
Sim. 1 & 0.42 & 0.51 & 0.525 & 0.425 & 0.49 & 0.505 & 0.51 & 0.46 & 0.615 \\
\hline
Sim. 2 & 1.25 & 1.21 & 1.065 & 0.995 & 1.05 & 1.005 & 0.89 & 0.46 & 0.615 \\
\hline
\end{tabular}
\end{center}
\vspace{0.3cm}
Si nota come la prima simulazione abbia fornito dati comparabili con quelli precedentemente stimati. Nella seconda simulazione, invece, la presenza di un ritardo sul carry di uscita di ogni full adder ha come conseguenza un generale aumento dell'attività delle uscite di somma. Tale ritardo causa infatti glitch, responsabili dell'aumento della E\textsubscript{sw}.
\\\\
Tale risultato è particolarmente evidente considerando la E\textsubscript{sw} totale dei due casi: si nota che la presenza del ritardo sui carry out raddoppia tale valore.\\\\
\centerline{$A(S) = \sum\limits_{i=0}^{N-1} A(S\textsubscript{i})$}\\
\vspace{0.2cm}
\begin{center}
\begin{tabular}{|c|c|c|}
\hline
 & Sim. 1 & Sim. 2 \\
\hline
A(S) & 3.845 & 7.925\\
\hline
\end{tabular}
\end{center}
\vspace{0.3cm}
\centerline{\includegraphics[width=15cm]{./img/Lab_1/Es_2/Glitch.png}}
\vspace{0.3cm}
È possibile notare, attraverso le waveforms, la presenza di commutazioni indesiderate nel secondo caso, rappresentato dal vettore di segnali s2.
\\\\
 \centerline{\includegraphics[width=15cm]{./img/Lab_1/Es_2/Glitch_worst_case.png}}
\\\\
\textcolor{blue}{In particolare, nell'immagine sopra riportata è possibile osservare come i bit relativi all'uscita di somma, a partire dal
quarto, presentino una continua commutazione fino al raggiungimento del valore logico corretto. La causa di tale comportamento è da ricercare
nelle transizioni a cui gli ingressi sono stati sottoposti nella simulazione. Le due somme, calcolate una di seguito all'altra,
sono le seguenti:
\vspace{0.3cm}
\begin{center}
\begin{tabular}{|c|c|c|}
\hline
& Somma 1 & Somma 2 \\
\hline
Addendo 1 & 10101000 & 00000100\\
\hline
Addendo 2 & 10101000 & 11111100\\
\hline
Risultato & 01010000 & 00000000\\
\hline
Carry in & 01010000 & \\
\hline
\end{tabular}
\end{center}
\vspace{0.3cm}
In particolare è possibile osservare che la somma 2 è soggetta ad una propagazione di carry dal terzo bit in poi, inoltre è importante tenere
in considerazione i carry in ingresso agli stadi lasciati dal risultato della somma 1, in quanto questi saranno una potenziale fonte di glitch propagandosi anch'essi lungo gli stadi. \\\\
In questo caso, la combinazione di carry lasciati dal calcolo precedente e la nuova operazione richiesta (somma 2) fanno si che il sommatore risulti in una condizione per cui, ad ogni colpo di clock, le uscite degli stadi successivi al secondo continueranno a commutare in modo alternato fino a che il carry introdotto dalla seconda operazione non raggiungerà il suddetto stadio, portando così
il bit di somma ad un risultato finale. 
\\\\
Si può notare che i primi 3 bit della somma non sono affetti da tale fenomeno, questi infatti non sono soggetti alla propagazione di carry derivanti dalle due somme. È possibile ricostruire una situazione simile per questi primi bit, ponendo in ingresso un susseguirsi di due
somme leggermente differenti dalle precedenti:
\vspace{0.3cm}
\begin{center}
\begin{tabular}{|c|c|c|}
\hline
& Somma 1 & Somma 2 \\
\hline
Addendo 1 & 10101010 & 00000001\\
\hline
Addendo 2 & 10101010 & 11111111\\
\hline
Risultato & 01010100 & 00000000\\
\hline
Carry in & 01010100 & \\
\hline
\end{tabular}
\end{center}
\vspace{0.3cm}
In tal modo il fenomeno di propagazione dei carry e delle commutazioni delle uscite di somma è esteso anche per i bit meno significativi. Di seguito è riportato un risultato della simulazione ottenuto ponendo tali valori in ingresso al sommatore.
\\\\\\
\centerline{\includegraphics[width=12cm]{./img/Lab_1/Es_2/Worst_case_nostro.png}}
}
\newpage
\section{Sintesi e analisi di potenza di un RCA}
È possibile effettuare una stima di potenza avanzata attraverso la piattaforma Synopsys. 
Partendo infatti dalla descrizione VHDL del RCA fornito, il software è in grado di compiere una sintesi ottimizzata e valutare parametri del circuito basandosi su una libreria di celle caratterizzate dal punto di vista di area, consumi e ritardi.
\\\\
Per poter stimare la potenza dinamica è necessario conoscere la frequenza di lavoro del circuito, ottenuta valutando il percorso combinatorio con ritardo maggiore: è possibile valutare tale parametro del circuito attraverso un timing report.
Il ritardo massimo riportato è pari a 0.78ns, di conseguenza è stato scelto un periodo di clock pari a 1ns.\\
Successivamente è possibile procedere con l'analisi relativa alla potenza.
Il comando power report consente di ottenere una generica stima della potenza dissipata dal circuito, distinguendo tre contributi:
\begin{itemize}
\item \textbf{leakage}: consumo statico dovuto alle correnti di leakage dei dispositivi utilizzati
\item \textbf{internal}: contributo alla potenza dinamica totale dovuto alla corrente di corto circuito
\item \textbf{switching}: contributo alla potenza dinamica dovuto alle commutazioni dei nodi e alle relative cariche/scariche delle capacità
\end{itemize}
Nella seguente tabella è riportata la suddivisione dei tre contributi.
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	Internal Power & Switching Power & Leakage Power & Total Power \\ 
	\hline
	16.7429 uW & 9.7406 uW & 953.4833 nW & 27.4370 uW \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
L'apporto maggiore al consumo totale è dato dalla potenza dinamica, in particolare dal consumo della potenza interna.\\
È interessante notare la suddivisione del consumo in potenza per i vari moduli interni (FA) dell'RCA. È possibile ottenere ciò tramite un power report di tipo gerarchico. La distribuzione dei consumi è riportata nella seguente tabella.
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	Blocco &  Switching Power & Internal Power & Leakage Power & Total Power \\ 
	\hline
	FA(8) & 0.848 uW & 2.154 uW & 119.291 nW & 3.121 uW  \\
	\hline
	FA(7) & 1.293 uW & 2.150 uW & 118.962 nW & 3.562 uW  \\
	\hline
	FA(6) & 1.332 uW & 2.191 uW & 119.340 nW & 3.642 uW  \\
	\hline
	FA(5) & 1.328 uW & 2.171 uW & 119.110 nW & 3.618 uW  \\
	\hline
	FA(4) & 1.278 uW & 2.101 uW & 119.294 nW & 3.498 uW  \\
	\hline
	FA(3) & 1.263 uW & 2.090 uW & 118.879 nW & 3.471 uW  \\
	\hline
	FA(2) & 1.229 uW & 2.002 uW & 119.508 nW & 3.351 uW  \\
	\hline
	FA(1) & 1.171 uW & 1.884 uW & 119.999 nW & 3.175 uW  \\
	\hline
	RCA & 9.741 uW & 16.743 uW & 953.483 nW & 27.437 uW  \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
Si nota come la suddivisione risulti simile per tutti i FA fatta eccezione per FA(8). In particolare si differenzia dagli altri per il consumo relativo alla potenza di switch. Si ipotizza che quest'ultima risulti inferiore rispetto agli altri full adder a causa del minor carico di uscita.
\\\\
È inoltre possibile approfondire l'analisi di potenza considerando i contributi delle celle interne ai singoli moduli. In particolare, vengono messi in luce i contributi delle celle che compongono i singoli FA, sempre suddivisi nei tre contributi precedentemente descritti.
Per comprendere l'origine del consumo inferiore del FA8, quest'ultimo è stato analizzato come cella ed è stato confrontato con FA1.
Lo schema del circuito interno e i risultati ottenuti sono riportati di seguito.
\\\\
\includegraphics[width=15cm]{./img/Lab_1/Es_3/Full_adder.png}
\\\\
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\multicolumn{5}{c}{FA(1) }\\
	\hline
	Cella &  Switching Power & Internal Power & Leakage Power & Total Dynamic Power \\ 
	\hline
	U4 & 0.5488 uW & 0.5899 uW & 36.1637 nW & 1.138 uW  \\
	\hline
	U3 & 0.1749 uW & 0.3374 uW & 32.5747 nW & 0.512 uW  \\
	\hline
	U2 & 0.3964 uW & 0.1377 uW & 14.2499 nW & 0.534 uW  \\
	\hline
	U1 & 0.0512 uW & 0.8205 uW & 36.0111 nW & 0.872 uW  \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\multicolumn{5}{c}{FA(8) }\\
	\hline
	Cella &  Switching Power & Internal Power & Leakage Power & Total Dynamic Power \\ 
	\hline
	U4 & 0.5365 uW & 0.5757 uW & 36.1637 nW & 1.112 uW  \\
	\hline
	U3 & 0.2155 uW & 0.4278 uW & 32.7466 nW & 0.643 uW  \\
	\hline
	U2 & 0.0332 uW & 0.1774 uW & 14.2174 nW & 0.211 uW  \\
	\hline
	U1 & 0.0624 uW & 0.9733 uW & 36.1631 nW & 1.036 uW  \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
La differenza nel consumo di potenza di switching è individuata nella cella U2, legata al carry in uscita dal singolo FA.
\\
È possibile ottenere informazioni aggiuntive sul calcolo della switching power relativa ai nodi interni ad un modulo con un'analisi di tipo net verbose. In tale analisi sono riportati i contributi capacitivi necessari al calcolo di tale potenza, espressi nodo per nodo.
\\\\
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\multicolumn{5}{c}{FA(1) }\\
	\hline
	Nodo &  Total Net Load & Static Probability & Toggle Rate & Switching Power \\ 
	\hline
	n1 & 4.694 fF & 0.493 & 0.1932 & 0.5488 uW  \\
	\hline
	n2 & 2.010 fF & 0.488 & 0.1439 & 0.1749 uW  \\
	\hline
	S & 0.310 fF & 0.507 & 0.2735 & 0.0512 uW  \\
	\hline
	Cout & 4.554 fF & 0.512 &  0.1439 & 0.3964 uW  \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\multicolumn{5}{c}{FA(8) }\\
	\hline
	Nodo &  Total Net Load & Static Probability & Toggle Rate & Switching Power \\ 
	\hline
	n1 & 4.694 fF & 0.499 & 0.1889 & 0.5365 uW  \\
	\hline
	n2 & 2.010 fF & 0.484 & 0.1772 & 0.2155 uW  \\
	\hline
	S & 0.310 fF & 0.497 & 0.3328 & 0.0624 uW  \\
	\hline
	Cout & 0.310 fF & 0.516 &  0.1772 & 0.0332 uW  \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
Si nota come il nodo legato al carry in uscita presenti una capacità inferiore per FA8. Ciò conferma l'ipotesi legata al carico inferiore.
\\
Analizzando i vari FA con analisi di tipo net verbose si nota inoltre che i contributi di capacità relativi ai nodi della somma (S) siano trascurabili rispetto agli altri contributi.
Di conseguenza si evince che il contributo di potenza relativo a tale nodo è di un ordine di grandezza inferiore rispetto agli altri.
\\\\
\textcolor{blue}{
Da un report di tipo net verbose è inoltre possibile confrontare i valori di static probability e toggle rate \textcolor{blue}{dei nodi di uscita di} un FA derivanti dalla simulazione con le probabilità in uscita e le attività stimate precedentemente in modo teorico. 
\\
Si nota come i valori di probabilità dei
nodi di uscita, S e Cout, siano distribuiti attorno al valore 0.5, dunque confrontabili con il caso precedentemente considerato di ingressi equiprobabili. 
\\
Il toggle rate rappresenta la frequenza media di commutazione associata al singolo nodo, che identifica, con il suo reciproco, il periodo medio
con cui tale nodo presenta una commutazione: attraverso tale valore è possibile stimare la switching activity dei nodi di somma e dei carry in uscita. In tal caso, poichè il periodo di clock è pari a 1ns, il valore di toggle rate riportato coincide con la switching activity del segnale. E' possibile notare come i valori simulati si distanzino da quelli teorici, in quanto all'interno del metodo probabilistico non viene tenuta in considerazione la correlazione spaziale e temporale tra diversi segnali. Tale fatto mette in luce, di conseguenza, le limitazioni che l'utilizzo di un modello probabilistico comporta.}
\newpage
\textcolor{blue}{CONFRONTO VERBOSE RCA
\\
E' stato richiesto inoltre un power report di tipo net verbose relativo all'intero RCA. Si può osservare come i contributi capacitivi relativi
ai nodi delle uscite di somma siano significativamente inferiori rispetto ai contributi dei nodi relativi ai carry tra uno stadio e quello successivo.
Anche in questo caso la motivazione è dovuta al carico capacitivo inferiore delle uscite di somma, che non risultano collegate ad ulteriori
blocchi. Tuttavia, osservando i contributi totali riportati dall'analisi di tipo verbose, è possibile osservare una differenza tra questi e 
quelli presenti nel power report precedentemente richiesto. 
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	& Internal Power & Switching Power & Leakage Power & Total Power \\ 
	\hline
	Power report & 16.7429 uW & 9.7406 uW & 953.4833 nW & 27.4370 uW \\
	\hline
	Net Verbose & 8.848 uW & 3.766 uW & 403.098 nW & 12.614 uW \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
I contributi riportati dall'analisi di tipo net verbose risultano proporzionalmente inferiori. La possibile causa di ciò è da attribuirsi al tipo
di analisi effettuata da Synopsys: in particolare la keyword -net utilizzata ha richiesto uno studio della potenza relativo ai nodi interni
dell'architettura dell'RCA, presenti tra i vari FA connessi. In tale analisi i contributi dei nodi interni ai FA stessi sono stati
tralasciati. Al contrario un'analisi di tipo power report fornisce un risultato completo comprendendo all'interno l'analisi di tutti i nodi dei
blocchi che compongono l'architettura.
}
\newpage
\section{MUX: generazione e propagazione di glitch}
L'obiettivo di questo esercizio è lo studio delle conseguenze 
introdotte dai ritardi delle porte, in particolare all'interno del
multiplexer rappresentato nella seguente figura.
\\\\\
\centerline{\includegraphics[width=5cm]{./img/Lab_1/Es_4/Mux.png}}
\\\\\
In questo caso particolare tutte le porte sono esenti da ritardi fatta
eccezione per l'inverter, caratterizzato da un ritardo di propagazione
pari a 0.1 ns.
\\\\
All'interno del file \textit{tb\textunderscore mux21\textunderscore
glitch.vhd} è stato possibile identificare la combinazione 
dei segnali di ingresso con i quali il multiplexer è stato
testato.
\begin{center}
\begin{listato}
	\centerline{\lstinputlisting{./code/Lab_1/Es_4/mux_input_delays.vhd}}
\end{listato}
\end{center}
In particolare, è possibile notare dal codice VHDL sopra riportato
che inizialmente gli ingressi assumono tutti un valore logico alto.
Dopo 1ns il segnale S commuta. L'uscita, in un caso ideale, non dovrebbe
presentare commutazioni.
\\
Tuttavia, si ipotizza che, a causa del ritardo di propagazione introdotto dall'
inverter, vi sia un intervallo temporale in cui i nodi interni X e Z 
assumono entrambi un valore logico basso, portando quindi l'uscita Y a 0. Tale comportamento atteso è mostrato nella seguente figura.
\\\\
\centerline{\includegraphics[width=7cm]{./img/Lab_1/Es_4/Mux_plot.png}}
\\\\
Per mezzo di una simulazione ModelSim è stato possibile osservare
attraverso le waveforms il comportamento reale dei segnali. Il risultato
di tale simulazione è riportato nella seguente immagine.\\
\\\\
\centerline{\includegraphics[width=7cm]{./img/Lab_1/Es_4/Glitch.png}}
\\\\
È possibile visualizzare direttamente sulla waveform dell'uscita Y
il glitch causato dall'inverter. Tale comportamento è in linea con 
quanto atteso.
\\\\
Al fine di analizzare altre possibili combinazioni degli ingressi
che possano generare un glitch in uscita è stata realizzata una 
mappa di Karnaugh rappresentante la funzione logica del multiplexer.
\\\\
\centerline{\includegraphics[width=8cm]{./img/Lab_1/Es_4/Mappa_K_coperta.png}}
\\\\
In particolare, è possibile notare che il circuito precedentemente riportato sia l'implementazione della funzione logica coperta da due implicanti, rappresentata nella figura precedente.
\\
Il glitch analizzato è dovuto ad una transizione degli ingressi che consegue in un passaggio
tra un implicante e l'altro. Tale problema potrebbe essere risolto
inserendo, in modo ridondante, un terzo implicante per evitare
la transizione precedentemente trattata. 
\\\\
\centerline{\includegraphics[width=8cm]{./img/Lab_1/Es_4/Mappa_K_supercoperta.png}}
\\\\
Tale ragionamento porta alla conclusione che l'unica combinazione in grado
di causare un glitch in uscita sia quella presa in analisi.
\\\\\
Essendo i glitch associati a commutazioni di nodi, questi portano un 
contributo aggiuntivo al consumo totale di potenza dinamica. In particolare
l'energia sprecata durante queste commutazioni spurie è la somma dei consumi
durante le due transizioni del segnale. Ciascuna delle due contribuisce all'energia secondo la seguente equazione:
\\\\
\centerline{$E = C \cdot V^{2}$}
\\\\
dove C rappresenta la capacità di carico e V la tensione a cui viene caricata
tale capacità.
\\
Metà di tale contributo di energia è usata per caricare o scaricare la
capacità di carico associata all'uscita, mentre la restante parte viene
dissipata.
Di conseguenza il consumo di energia totale associato ad un glitch è 
dato da:
\\\\
\centerline{$E = 2 \cdot C \cdot V^{2}$}
\\\\
\newpage
\section{Calcolo di probabilità e attività: contatore sincrono}
Nella prima parte di questo esercizio è stato analizzato il timing del blocco 
rappresentato nella figura seguente.
\\\\
\centerline{\includegraphics[width=3cm]{./img/Lab_1/Es_5/Sync_FA.png}
			\includegraphics[width=7cm]{./img/Lab_1/Es_5/Half_add_contatore.png}}
\\\\
In particolare è stato possibile stabilire il suo comportamento atteso. 
Quando il segnale B0 è asserito, l'uscita S presenta una commutazione 
per ogni fronte sensibile del clock. Al contrario, quando B0 non è attivo, 
l'uscita non presenta alcuna commutazione.
\\\\
È possibile utilizzare tali strutture per realizzare un contatore sincrono,
come mostrato in figura. In particolare, i segnali di CEN e OVFL rappresentano
rispettivamente l'enable del contatore e il terminal count di questo.
\\\\
\centerline{\includegraphics[width=15cm]{./img/Lab_1/Es_5/Counter.png}}
\\\\
Considerando infatti il comportamento delle uscite S0, S1 e S2 quando il segnale di 
enable è attivo si ottiene il seguente timing.
\\\\
\centerline{\includegraphics[width=10cm]{./img/Lab_1/Es_5/Contatore.png}}
\\\\
Dalle considerazioni fatte in precedenza è possibile stimare il numero
di commutazioni delle 8 uscite e del terminal count durante 
un intero ciclo di conta. Inoltre, nella tabella seguente sono stati
aggiunti i dati ottenuti tramite power report, ottenuto attraverso 
una simulazione ModelSim. Il clock utilizzato per la simulazione ha un periodo
di 2ns.
\\
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
	Segnale & Transizioni stimate & Transizioni simulate \\ 
	\hline
	S0 & 255 & 257 \\
	\hline
	S1 & 127 & 128\\
	\hline
	S2 & 63 & 64\\
	\hline
	S3 & 31 & 32\\
	\hline
	S4 & 15 & 16 \\
	\hline
	S5 & 7 & 8 \\
	\hline
	S6 & 3 & 4 \\
	\hline
	S7 & 1 & 2 \\
	\hline
	OVFL & 1 & 16 \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
Si può notare che, senza considerare il segnale OVFL,
i risultati ottenuti in entrambi i casi siano
confrontabili, tuttavia è presente una leggera differenza, pari
a 1 o 2 colpi di clock, dovuta al fatto che è stato scelto un 
tempo di simulazione leggermente superiore al tempo di conta 
totale.
\\
\textcolor{blue}{Riguardo al segnale di OVFL, il risultato simulato
è distante da quello atteso, in quanto il segnale presenta un numero di commutazioni
decisamente maggiore. Tale segnale, al contrario di quelli di uscita della somma (rappresentanti il conteggio), non 
presenta un elemento sequenziale che lo interfacci con l'esterno. Per tale motivo
sono ben visibili tutte le commutazioni spurie del segnale stesso, dovute ai ritardi
di propagazione definiti all'interno dei vari stati del contatore.}
\\\\
Dalla simulazione è stato inoltre possibile osservare l'andamento 
delle waveforms delle uscite, riportato nella figura sottostante.
\\\\
\centerline{\includegraphics[width=15cm]{./img/Lab_1/Es_5/Glitch.png}}
\\\\
Si nota che, in
un preciso intervallo temporale, il segnale OVFL assume un valore 
logico alto durante il conteggio, comportamento inatteso da parte
di un contatore. 
Tale glitch avviene in seguito alla commutazione
del bit più significativo (S7); infatti, per un certo intervallo di tempo,
in ingresso all'half adder del blocco 7 sono presenti due ingressi con valore
logico alto: uno dovuto al carry in uscita dal blocco precedente che, a causa
dei ritardi, non ha ancora commutato il suo valore, e l'altro relativo all'uscita
attuale S7.
\\\\
Successivamente, sempre attraverso un power report, è stato possibile
analizzare l'attività dei segnali interni al contatore. I risultati sono 
riportati nella seguenti tabelle.
\\
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
	Segnale & Commutazioni & Attività \\ 
	\hline
	SUM(0) & 258  & 0.992  \\
	\hline
	SUM(1) & 385  & 1.377  \\
	\hline
	SUM(2) & 320  &  1.231  \\
	\hline
	SUM(3) & 224  & 0.862  \\
	\hline
	SUM(4) & 144  & 0.554  \\
	\hline
	SUM(5) & 88  & 0.338  \\
	\hline
	SUM(6) & 52  & 0.200  \\
	\hline
	SUM(7) & 30  & 0.115  \\
	\hline
	\end{tabular}	
	\begin{tabular}{|c|c|c|}
	\hline
	Segnale & Commutazioni & Attività \\ 
	\hline
	Cout(0) & 257  & 0.988  \\
	\hline
	Cout(1) & 256  & 0.985  \\
	\hline
	Cout(2) & 192  & 0.738  \\
	\hline
	Cout(3) & 128  & 0.492  \\
	\hline
	Cout(4) & 80  & 0.308  \\
	\hline
	Cout(5) & 48  & 0.185  \\
	\hline
	Cout(6) & 28  & 0.108  \\
	\hline
	Cout(7) & 16  & 0.062  \\
	\hline
	\end{tabular}
\end{center}
\vspace{0.3cm}
È possibile notare come l'attività delle somme in uscita dagli
half adder sia differente rispetto alle uscite sincrone dei flip-flop.
Infatti, a causa dei ritardi di propagazione dei carry in uscita dai 
singoli stadi, si generano una serie di glitch, che, propagandosi lungo
la serie di half adder, causano commutazioni multiple dei nodi SUM.
\\\\
Similmente all'analisi effettuata per il blocco 7 è possibile ipotizzare
comportamenti simili legati al carry in uscita anche per gli altri blocchi.
Tale vettore di carry presenta infatti un'attività complessiva maggiore 
rispetto a quella stimata nel caso senza ritardi.
\\\\
Nella simulazione precedentemente effettuata i ritardi sono stati
modellizzati in modo tale da presentare un valore significativamente
inferiore rispetto al periodo di clock.
\\\\
\centerline{$Periodo = 2ns \\
            Ritardo\textunderscore somma = 0.2ns \\
            Ritardo\textunderscore carry = 0.2ns $}
\\\\
Si nota che in questo caso il periodo di clock è 
sufficientemente elevato per garantire un corretto funzionamento 
del contatore: la propagazione del carry out può avvenire correttamente
in tutti gli stadi.
\\\\
Riducendo il periodo di clock a 0.8ns è possibile osservare un
comportamento inatteso, rappresentato in figura, da parte del contatore.
\\\\
\centerline{\includegraphics[width=15cm]{./img/Lab_1/Es_5/Clk_corto.png}}
\\\\
L'immagine mette in luce una transizione da un conteggio all'altro:
\\\\
\centerline{$00011111 \rightarrow 00010000$}
\\\\
Tale errore è dovuto alla mancata completa propagazione del carry in tutti
gli stadi, infatti il clock campiona le uscite dei flip-flops prima che tutti
gli stadi abbiano raggiunto un valore stabile. 
\\\\
\textcolor{blue}{La presenza di glitch all'interno del contatore in analisi comporta
un incremento dei consumi rispetto al caso ideale. Una possibile soluzione, che potrebbe
essere adottata per garantire un numero inferiore di commutazioni spurie modificando il VHDL, è legata
all'aumento del ritardo coinvolto nel calcolo della somma per i singoli HA. 
Se tale tempo fosse infatti maggiore o uguale del massimo tempo di propagazione 
del carry attraverso tutti gli stadi, le uscite SUM non presenterebbero più un elevato numero di glitch.
\\\\
FORSE CI STAREBBE VERIFICARE CON UNA SIMULAZIONE E NEL CASO METTERE I RISULTATI}
\\\\
\textcolor{red}{COSE DA FARE: \\
                 - Capire il toggle rate nel verbose (ESW)IPOTESI FATTE  \\
                 - Capire l'incongruenza del verbose RCA FATTO \\
                 - Spiegare il worst case del sommatore FATTO \\
                 - Fare mappa di Karnaugh FATTO \\
                 - Plot segnali MUX (fatto da noi) FATTO \\
                 - Plot dei segnali del blocchetto contatore e dei primi bit del contatore (fatto da noi) FATTO\\
                 - Completare le tabelle FATTO\\
                - Revisione grafica FATTO }  
\newpage
\chapter{Laboratorio 2 - FSM Assignment and VHDL Synthesis}    
\section{FSM State Assignment}
\subsection{Progetto}
L'obiettivo del progetto è la definizione di una macchina  a stati al fine di realizzare un algoritmo di somma tra 6 input, utilizzando il datapath in figura seguente e scegliendo l'ordine con cui collegare i diversi ingressi ai multiplexer.
\\\\
\centerline{\includegraphics[width=8cm]{./img/Lab_2/Datapath.png}}
\\\\   
In particolare, al fine di minimizzare i consumi della macchina a stati, è necessario ridurre al minimo il numero di commutazioni di:
\begin{itemize}
\item variabili di stato
\item segnali di controllo
\end{itemize} 
Essendo i segnali di controllo coincidenti con i selettori dei multiplexer, è stata innanzitutto stabilita una sequenza per la selezione dei diversi input tale per cui il numero di commutazioni durante l'esecuzione dell'intero algoritmo di somma fosse minimo.
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	Operazione & S3 & S2 & S1 & S0 \\ 
	\hline
	A+B & 0 & 1 & 0 & 1 \\
	\hline
	S+C & 0 & 0 & 0 & 0  \\
	\hline
	S+D & 0 & 0 & 1 & 0  \\
	\hline
    E+S & 1 & 0 & 1 & 1  \\
	\hline
	F+S & 1 & 1 & 1 & 1 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}     
È possibile notare come sia necessario riportare il valore della somma, denominato S, in ingresso ad entrambi i multiplexer.
\\
Nella transizione da uno stato all'altro il numero di commutazioni coincide con la variazione degli addendi; ne consegue che il massimo numero di commutazioni durante una transizione risulta pari 2.\\
Considerando un ciclo di esecuzione dell'algoritmo, è possibile stimare il numero totale di commutazioni sui segnali di selezione e la loro switching activity.\\
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	 & S3 & S2 & S1 & S0 \\ 
	\hline
	Commutazioni in un ciclo & 2 & 2 & 2 & 2 \\
	\hline
	Attività & 0.4 & 0.4 & 0.4 & 0.4  \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}  
Il numero di commutazioni totale risulta quindi pari a 8.\\
È stata scelta dunque la seguente configurazione degli ingressi 
\\\\
\centerline{\includegraphics[width=8cm]{./img/Lab_2/Datapath_input.png}}
\\\\  
Il passo successivo è la scelta della codifica dei singoli stati. In tale contesto è importante tenere in considerazione che una generica FSM presenta una rete per la generazione degli output e una rete per il calcolo dello stato futuro. 
\\\\
Una codifica ottimale punta alla minimizzazione delle commutazioni in entrambe le reti. Per tale scopo si è deciso di far coincidere le due reti, in modo che la logica utilizzata per generare le uscite possa essere sfruttata anche per la definizione dello stato futuro. In particolare, la codifica dello stato futuro si ottiene a partire dalle uscite di controllo dello stato attuale.
\\
\begin{center}
	\begin{tabular}{|c||c||c|c|c|c|}
	\hline
	Operazione & Codifica dello stato & S3 & S2 & S1 & S0 \\ 
	\hline
	A+B & 1 1 1 & 0 & 1 & 0 & 1 \\
	\hline
	S+C & 1 0 1 & 0 & 0 & 0 & 0 \\
	\hline
	S+D & 0 0 0 & 0 & 0 & 1 & 0 \\
	\hline
	E+S & 0 1 0 & 1 & 0 & 1 & 1 \\
	\hline
	F+S & 0 1 1 & 1 & 1 & 1 & 1 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}  
È possibile notare come tutte le transizioni presentino una distanza di Hamming pari a 1, fatta eccezione della transizione da S+C a S+D, nella quale tale distanza è pari a 2.
\\
In tale contesto, la sola logica combinatoria necessaria è relativa alla valutazione delle uscite a partire dalla codifica dello stato attuale.
\\\\
Si è notato che tali funzioni logiche presentano un'implementazione semplice con un numero limitato di porte. Di seguito sono riportate le mappe di Karnaugh per le funzioni logiche sopra descritte.
\\\\
\centerline{\includegraphics[width=7cm]{./img/Lab_2/K_S3.png}
			\includegraphics[width=7cm]{./img/Lab_2/K_S2.png}}
\\\\
\centerline{\includegraphics[width=7cm]{./img/Lab_2/K_S1.png}
			\includegraphics[width=7cm]{./img/Lab_2/K_S0.png}}
\\\\
È possibile notare che le funzioni logiche presentano implicanti in comune, semplificando maggiormente la logica necessaria.
\\
\subsection{Descrizione VHDL e simulazione Modelsim}
La macchina a stati precedentemente definita è stata descritta attraverso il VHDL, specificando in particolare la codifica degli stati progettata.
\\\\
\textcolor{red}{DOBBIAMO METTERE IL VHDL? fare eventuale appendice}
\\\\
Al fine della simulazione, datapath e FSM sono stati inclusi in un'unica entity per ottenere il Processing Element complessivo. È stato dunque realizzato un testbench per verificare il corretto susseguirsi degli stati e le relative transizioni dei segnali.
In particolare, è stata effettuata una simulazione di 2000 colpi di clock, che ha fornito i seguenti risultati attraverso un power report.
\\
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
	Segnale & Tc & Activity \\ 
	\hline
	Clock & 4000 & 2 \\
	\hline
	S3 & 799 & 0.3995 \\
	\hline
	S2 & 802 & 0.4010 \\
	\hline
	S1 & 799 & 0.3995 \\
	\hline
	S0 & 802 & 0.4010 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}  
Le attività ottenute sono comparabili con quelle stimate in fase di progetto.  
\\
\section{Sintesi del VHDL} 
In tale sezione è stata effettuata la sintesi della top level entity che comprende sia FSM sia datapath.
\\
Inizialamente i file sono stati analizzati nel corretto ordine ed è stata elaborata la struttura del Processing Element.
\\
Successivamente è stato generato un clock di periodo pari a 10 ns.
\\\\
\centerline{\textbf{create\_clock -name "CLK" -period 10 {CLK}} }
\\\\
È stata verificata la presenza del clock generato attraverso il comando \textbf{report\_clock}.
\\
Successivamente è stata effettuata la sintesi attraverso la direttiva \textbf{compile -exact map}.
\\\\
In seguito è stato possibile visualizzare, in modo gerarchico, la mappatura del circuito con la libreria scelta. Nell'immagine seguente, in particolare, è riportato lo schematico della macchina a stati.
\\\\
\centerline{\includegraphics[width=15cm]{./img/Lab_2/FSM_Schematic.png}}
\\\\ 
È possibile notare, come atteso, che il numero di porte logiche utilizzato risulta limitato.
\\
Sono stati effettuati una serie di report inizialmente sulla top level entity per poi analizzare in modo più approfondito la macchina a stati.
\\
In primo luogo è stata ottenuta una stima dell'area delle celle utilizzate nella sintesi, attraverso il comando \textbf{report\_area}.
\\\\
\centerline{Total cell area = 295.53 um2}
\\\\
Successivamente, al fine di valutare lo slack, sono stati analizzati i 10 percorsi combinatori con ritardi maggiori.
\\\\
\centerline{\textbf{report\_timing -nworst 10}}
\\\\
Per semplicità sono riportati i dati relativi al critical path.
\\
\begin{center}
	\begin{tabular}{|c|c|}
	\hline
	Clock period & 10 ns\\
	\hline
	Data required time & 9.97 ns \\
	\hline
	Data arrival time & 1.94 ns \\
	\hline
	Slack & 8.02 ns \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}  
Come è possibile notare, lo slack risulta particolarmente elevato se confrontato con il periodo di clock.
Nel report sono inoltre presenti i ritardi relativi agli elementi compresi tra lo start-point e l'end-point del percorso critico.
\\\\
È possibile ottenere informazioni riguardo alla potenza dissipata attraverso il comando \textbf{report\_power}. In particolare, si evidenziano i tre contributi relativi alla top level entity.
\\
\begin{center}
	\begin{tabular}{|c|c|}
	\hline
	Internal Power & 29.4711 uW \\
	\hline
	Switching Power & 13.2924 uW \\
	\hline
	Leakage Power & 5.4747 uW \\
	\hline
	Total Power & 48.2382 uW \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}  
Sono stati ottenuti dati aggiuntivi relativi al consumo di potenza dei singoli moduli dell'architettura, tramite l'aggiunta della direttiva \textbf{-hier}.
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
	FSM & 4.504 uW & 9.3\% \\
	\hline
	Datapath & 43.734 uW & 90.7\% \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}  
Il consumo della macchina a stati rappresenta una percentuale ridotta rispetto al valore totale.
\\
Al fine di approfondire lo studio relativo ai nodi interni del circuito, è stata realizzata un'analisi di tipo \textbf{-net}. In particolare sono riportati i risultati relativi ai nodi dei segnali di selezione dei multiplexer.
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	Segnale & Net Load [fF] & Static Probability & Toggle Rate & Switching Power [uW] \\
	\hline
	 sel11\_wire & 13.792  &  0.120  &  0.0246  & 0.2055 \\
	\hline
	 sel01\_wire & 10.222  &  0.253  &  0.0272  & 0.1682 \\
	\hline
	sel10\_wire & 8.489  &  0.720  &  0.0301  & 0.1547\\
	\hline
	sel00\_wire & 7.058  &  0.720  &  0.0301  & 0.1286 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}
Il periodo medio di variazione dei selettori, ottenibile dal toggle rate, è confrontabile con le variazioni medie che avvengono su tali segnali in un ciclo di esecuzione. È importante tenere in considerazione la possibile presenza di commutazioni non previste a causa dell'attivazione del segnale di reset durante la simulazione, il quale è caratterizzato da una probabilità non nulla di commutazione.
\\\\
È possibile imporre dei vincoli sui vari parametri coinvolti nel processo di sintesi. In particolare, è stato generato un segnale di clock alla massima frequenza consentita dal circuito. La stima di tale frequenza è stata effettuata a partire dall'analisi del critical path precedentemente riportato.
\\
\begin{center}
	\begin{tabular}{|c|c|}
	\hline
	Clock period & 1.94 ns\\
	\hline
	Data required time & 1.91 ns \\
	\hline
	Data arrival time & 1.91 ns \\
	\hline
	Slack & 0 ns \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm} 
Come atteso, lo slack relativo al percorso critico risulta essere nullo, di conseguenza il circuito opera alla massima frequenza supportata.
Dal momento che la potenza dissipata è funzione della frequenza di lavoro, è stato riscontrato un aumento dei consumi.
\\
\begin{center}
	\begin{tabular}{|c|c|}
	\hline
	Internal Power & 151.3501 uW \\
	\hline
	Switching Power & 69.4127 uW \\
	\hline
	Leakage Power & 5.5735 uW \\
	\hline
	Total Power & 226.3363 uW \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm} 
A seguito di un incremento della frequenza di un fattore di circa 5, la potenza è aumentata proporzionalmente.
\\\\
\textcolor{red}{È inoltre possibile imporre un vincolo sul contributo totale di potenza dinamica, attraverso la direttiva
\\\\
\centerline{\textbf{set\_max\_dynamic\_power}}
\\\\
Tale valore è stato fissato a 40 uW, leggermente inferiore rispetto alla potenza dinamica ottenuta nelle prime simulazioni.
\\
In particolare, è stato considerato il clock di partenza di periodo pari a 10 ns.
Di seguito sono riportati i risultati ottenuti.}
\\
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
	& No constraints & Power constraints\\
	\hline
	Internal Power & 29.4711 uW & 33.8116 uW \\
	\hline
	Switching Power & 13.2924 uW & 13.3092 uW \\
	\hline
	Total Dynamic Power & 42.76 uW & 47.12 uW \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}  
\textcolor{red}{I risultati ottenuti dalla sintesi non risultano in linea con quanto atteso, infatti è registrato un aumento del consumo di potenza dinamica.
\\
Si ipotizza che il consumo di potenza dinamica ottenuto nella prima sintesi fosse già prossimo al minimo globale.}
\\\\
Successivamente è stata effettuata un'analisi più dettagliata della FSM accedendovi tramite la direttiva\textbf{ current\_instance FSM}.\\
Attraverso il comando \textbf{report\_fsm} è stato possibile verificare la corretta implementazione della codifica progettata.
\\\\
È possibile risalire alla suddivisione del consumo della potenza dinamica all'interno delle celle che costituiscono la FSM attraverso un'analisi di potenza di tipo \textbf{-cell}. In particolare, nella seguente tabella vengono riportati i tre contributi maggiori relativi al consumo di potenza dinamica.
\\
\begin{center}
	\begin{tabular}{|c|c|}
	\hline
	  ps\_reg[1] & 1.143 uW  \\
	\hline
	 ps\_reg[2] & 0.979 uW\\
	\hline
	ps\_reg[0] & 0.924 uW\\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}
Si nota che tali contributi sono relativi alle variabili di stato, che presentano numerose commutazioni durante l'esecuzione dell'algoritmo.
\\
Uno studio più approfondito sulla switching power relativa ai nodi interni è ottenuta tramite un'analisi di tipo \textbf{-net}. In particolare, nella seguente tabella, sono riportati i dati relativi ai segnali di uscita della FSM, ovvero i segnali di selezione dei multiplexer.
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	Segnale & Net Load [fF] & Static Probability & Toggle Rate & Switching Power [uW] \\
	\hline
	 S11 & 13.792  &  0.120  &  0.0246  & 0.2055 \\
	\hline
	 S01 & 10.222  &  0.253  &  0.0272  & 0.1682 \\
	\hline
	S10 & 8.489  &  0.720  &  0.0301  & 0.1547\\
	\hline
	S00 & 7.058  &  0.720  &  0.0301  & 0.1286 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}
È possibile notare che tali valori coincidono con quelli ottenuti precedentemente durante l'analisi -net della top level entity. Il contributo maggiore del consumo è dovuto alle capacità di carico dei nodi in analisi, che assumono  valori significativi rispetto agli altri nodi. Questo è il principale motivo per cui tali segnali contribuiscono maggiormente, data la parità di toggle rate.
\\\\
Per ragioni di praticità, tali sintesi sono state effettuate raggruppando i comandi e le direttive in uno script in modo darendere il processo automatico. Di seguito è riportato uno degli script utilizzati.
\begin{center}
\begin{listato}
	\centerline{\lstinputlisting{./code/Lab_2/commands.txt}}
\end{listato}
\end{center}

\chapter{Laboratorio 3 - Clock gating e soluzioni architetturali}
\section{Un primo approccio al clock gating}
Il clock gating è una tecnica di riduzione dei consumi a livello architetturale, il cui scopo è impedire la commutazione del segnale di clock in determinate parti del circuito non utilizzate.
\\
È fornita una descrizione VHDL del seguente circuito.
\\
\centerline{\includegraphics[width=8cm]{./img/Lab_3/circuito_clk_bug.png}}
\\
Dal file VHDL è possibile notare il valore assegnato ai segnali D1, D2 e D3:
\begin{center}
\begin{listato}
	\centerline{\lstinputlisting{./code/Lab_3/d1_d2_d3.vhd}}
\end{listato}
\end{center}
Essendo il segnale di clock enable sempre attivo, è atteso che l'uscita D3 assuma un valore pari a D1 dopo due cicli di clock. Tale comportamento non è verificato da una prima simulazione ModelSim effettuata.
\\
Come possibile notare dalla seguente figura, al primo fronte di clock successivo al reset, il valore di D1 è già riportato in uscita al flip-flop controllato dal segnale di strobe.
\\\\
\centerline{\includegraphics[width=10cm]{./img/Lab_3/clk_bug.png}}
\\\\
Ciò accade poiché il simulatore, in assenza di informazioni sui ritardi, deve comunque simulare il circuito mantenendo una causalità nella propagazione dei segnali all'interno degli elementi descritti.
\\
Come conseguenza, l'informazione relativa al clock, a causa della presenza di una porta AND, è riportata all'ingresso del secondo flip-flop uno step simuazione dopo rispetto al primo. Tale comportamento è deleterio in quanto altera il timing previsto del circuito.
\\\\
Per assicurare il corretto funzionamento del circuito, è sufficiente indicare la presenza di un ritardo CK- > Q per entrambi i flip-flop. A tale scopo è stato modificato il file \textbf{fd.vhd}.
\begin{center}
\begin{listato}
	\centerline{\lstinputlisting{./code/Lab_3/ff_delay.vhd}}
\end{listato}
\end{center}
Il ritardo aggiunto sulla propagazione dell'uscita permette di raggiungere il risultato atteso dalla simulazione.
\\\\
\centerline{\includegraphics[width=10cm]{./img/Lab_3/clk_bug_resolved.png}}
\\\\
Si nota che se la porta AND fosse caratterizzata da un ritardo maggiore rispetto al ritardo precedentemente inserito, il valore campionato non sarebbe quello corretto. In particolare, l'errore riscontrato è analogo a prima, come mostrato nella seguente figura.
\\\\
\centerline{\includegraphics[width=10cm]{./img/Lab_3/clk_bug_delay.png}}
\newpage
\section{Clock gating per un circuito complesso}
\subsection{Simulazione del circuito}
All'interno del file \textbf{inccomp.vhd} è presenta una descrizione del circuito mostrato nella figura seguente.
\\\\
\centerline{\includegraphics[width=10cm]{./img/Lab_3/inccomp_no_gating.png}}
\\\\
Dal codice si evince che il circuito è in grado di incrementare e confrontare due valori, rappresentati su 8 bit, contenuti nei registri A e B, e portare il maggiore di essi in uscita. In particolare, l'operazione di incremento è gestita attraverso INCA e INCB, due segnali attivi alti.
\\
È stato realizzato un testbench con lo scopo di simulare e verificare il comportamento del circuito.
\\\\
\centerline{\includegraphics[width=10cm]{./img/Lab_3/inccomp_no_gating_behavior.png}}
\\\\
Come possibile notare dalle forme d'onda sopra riportate, il comportamento è in linea con quanto atteso.
\\ 
Infatti, il segnale INCA viene campionato per tre colpi di clock prima che INCB risulti attivo, ciò porta il valore contenuto in REG\_A uguale a 3. In seguito, asserendo INCB, anche il valore contenuto in REG\_B inizia ad aumentare. Nei cicli di clock in cui entrambi INCA e INCB sono asseriti, la differenza tra i due dati rimane costante. Nel momento in cui INCA viene negato, il valore in uscita dal circuito rimane costante fino a che il dato contenuto in REG\_B risulti maggiore: questo accade esattamente dopo tre cicli di clock.
\\\\
Nel caso in cui i segnali di incremento non siano asseriti, non è necessario far commutare il clock all'interno dei registri, in quanto nessun valore deve essere aggiornato; a tal proposito, è possibile sfruttare la tecnica del clock gating. Una possibile implementazione è mostrata nella seguente figura.
\\\\
\textcolor{red}{Circuito applicazione clk gating a mano}
\\\\
È possibile notare la presenza di due latch atti a filtrare eventuali glitch presenti sugli ingressi INCA e INCB.
\subsection{Sintesi del circuito}
Inizialmente è stata effettuata una sintesi in assenza di direttive per l'implementazione del clock gating.
Successivamente alla generazione di un clock di periodo pari a 5 ns, è stato effettuato un power report includendo anche il contributo dei nodi relativi agli ingressi attraverso la direttiva \textbf{-include\_input\_net}.
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	\multicolumn{4}{c}{Power report - no clock gating, statistica di default} \\
	\hline
	Internal power [uW] & Net switching power [uW] & Leakage power [uW] & Total power [uW] \\
	\hline
	 38.7514 & 13.6944  &  3.7969  &  56.2428 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}
Un'analisi di potenza di tipo net permette di ottenere informazioni più dettagliate sulla statistica dei segnali e sulle capacità coinvolte. 
\\
In particolare, si nota che le capacità relative ai nodi di ingresso assumono un valore significativo, di conseguenza è importante tenere in considerazione tali nodi in una stima di potenza.
\\
Sono riportate le informazioni statistiche relative ai segnali di clock, reset, INCA e INCB.
\\
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
Segnale & Static probability & Toggle rate \\
	\hline
	 clock & 0.5  &  0.4 \\
	\hline
	 reset & 0.5  &  0.02 \\
	\hline
	 INCA & 0.5  &  0.02 \\
	\hline
	 INCB & 0.5  &  0.02 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}
È possibile notare come tali valori non siano realistici rispetto ai segnali presi in considerazione.
\\
È possibile effettuare stime più accurate comunicando al sintetizzatore i dati statistici relativi ai segnali. In particolare, è stata inizialmente modificata la statistica del segnale di reset, impostando la static probability = 0.
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	\multicolumn{4}{c}{Power report - no clock gating, reset modificato}\\
	\hline
	Internal power [uW] & Net switching power [uW] & Leakage power [uW] & Total power [uW] \\
	\hline
	 27.6360 & 14.8140  & 4.18  &  46.6302 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}
In seguito, impostando le statistiche relative ai segnali INCA e INCB con static probability pari a 0.12 e toggle rate pari a 0.025, come specificato nella consegna, si ottengono i seguenti risultati.
\textcolor{red}{Aggiornare dati in tabella sotto}
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	\multicolumn{4}{c}{Power report - no clock gating, reset e ingressi modificati}\\
	\hline
	Internal power [uW] & Net switching power [uW] & Leakage power [uW] & Total power [uW] \\
	\hline
	 27.6360 & 14.8140  & 4.18  &  46.6302 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}
Si nota una sensibile riduzione dei consumi dovuti al minor numero di commutazioni medie dei segnali in ingresso.
\\
È possibile ottenere il numero totale di celle utilizzato dal sintetizzatore attraverso un report di tipo cell.
\\
\begin{center}
	\begin{tabular}{|c|c|}
	\hline
	Numero celle & Area [um 2] \\
	\hline
	 74 & 229.29 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}
Attraverso una particolare descrizione VHDL, è possibile notificare al sintetizzatore la possibilità di implementare la tecnica del clock gating, ce può essere richiesta nella fase di sintesi attraverso la direttiva \textbf{-gate\_clock}.
Utilizzando sempre un clock di periodo 5 ns sono stati ottenuti i seguenti risultati, includendo sempre i contributi dovuti ai nodi di ingresso.       
\\
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	\multicolumn{4}{c}{Power report - clock gating, statistiche di default}\\
	\hline
	Internal power [uW] & Net switching power [uW] & Leakage power [uW] & Total power [uW] \\
	\hline
	 32.9555 & 10.8986  & 3.9349  &  47.7882 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}         
Come atteso, il clock gating ha portato ad una riduzione della potenza generale rispetto al caso in cui tale tecnica non è stata implementata. In particolare, è possibile notare una riduzione della potenza dinamica e un leggero aumento della potenza di leakage: si ipotizza che tale incremento sia dovuto ad un numero maggiore di celle.
\\
Successivamente, come effettuato in precedenza, sono state modificate le statistiche relative ai segnali di reset, INCA e INCB.
\begin{center}
	\begin{tabular}{|c|c|c|c|}
	\hline
	\multicolumn{4}{c}{Power report - clock gating, reset e ingressi modificati}\\
	\hline
	Internal power [uW] & Net switching power [uW] & Leakage power [uW] & Total power [uW] \\
	\hline
	 13.3592 & 5.8499  & 4.2570  &  23.4661 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}        
L'effetto del clock gating risulta più marcato adottando una statistica più realistica dei segnali presi in considerazione.
\\
Tuttavia, tale implementazione richiede l'impiego di un numero maggiore di celle atte all'inserimento della logica necessaria alla gestione del clock gating.     
\\
\begin{center}
	\begin{tabular}{|c|c|}
	\hline
	Numero celle & Area [um 2] \\
	\hline
	 78 & 238.07 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}          
È possibile navigare all'interno dello schematico al fine di individuare le celle relative all'implementazione di tale tecnica.        
\\\\
\centerline{\includegraphics[width=13cm]{./img/Lab_3/clock_gating_cells.png}}
\\\\
Si nota la presenza di due strutture aggiuntive che controllano il clock in ingresso ai due registri REG\_A e REG\_B. In particolare, è possibile visualizzare l'interno di tali strutture, costituite da un latch attivo basso seguito da una porta AND.
\\\\
\centerline{\includegraphics[width=10cm]{./img/Lab_3/clock_gating_implementation.png}}
\\\\       
Si nota che non è presente nessuna struttura adibita al clock gating sul registro in uscita. Infatti, dalla descrizione VHDL, il sintetizzatore non è in grado di riconoscere la possibilità di applicare il clock gating. A tal proposito, il codice è stato modificato al fine di includere questa opzione.
\begin{center}
\begin{listato}
	\centerline{\lstinputlisting{./code/Lab_3/clock_gating_output.vhd}}
\end{listato}
\end{center}
In particolare, è stato notato che all'interno del process per la descrizione dell'architettura, l'aggiornamento dei registri REG\_A e REG\_B avviene successivamente a due condizioni di if relative al valore di INCA e INCB. Si ipotizza che tramite tale descrizione il sintetizzatore sia in grado di applicare il clock gating. Di conseguenza, tale sintassi è stata adottata anche per descrivere l'aggiornamento del registro in uscita, il quale deve essere aggiornato solo quando almeno un segnale di incremento viene asserito.
\\\\
Nelle seguenti tabelle sono riportati i risultati relativi ai consumi.      
\begin{center}
	\begin{tabular}{|c|c|c|c|c|}
	\hline
	\multicolumn{3}{c}{Power report - statistiche di default}\\
	\hline
	& No clock gating & Clock gating \\
	\hline
	Internal power [uW] & 39.1897 & 33.1194 \\
	\hline
	Net switching power [uW] & 14.8742  & 10.8040 \\
	\hline
	Leakage power [uW] & 4.6358 & 4.0346 \\
	\hline
	Total power [uW] & 58.6997 & 47.9580 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}      
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
	\multicolumn{3}{c}{Power report - reset modificato}\\
	\hline
	& No clock gating & Clock gating \\
	\hline
	Internal power [uW] & 28.3881 & 27.8883 \\
	\hline 
 	Net switching power [uW] & 16.4611 & 11.9228 \\
	\hline
	Leakage power [uW] & 4.6611 & 4.4199 \\
	\hline
	Total power [uW] & 49.5103 & 44.2311 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm} 
\textcolor{red}{Aggiornare tabella sotto}          
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
	\multicolumn{3}{c}{Power report - reset e ingressi modificati}\\
	\hline
	& No clock gating & Clock gating \\
	\hline
	Internal power [uW] & 21.3760 & 27.8883 \\
	\hline 
 	Net switching power [uW] & 1.6626 & 11.9228 \\
	\hline
	Leakage power [uW] & 4.6611 & 4.4199 \\
	\hline
	Total power [uW] & 49.5103 & 44.2311 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm}          
Si nota che il clock gating porta ad una riduzione generale della potenza, come già verificato in precedenza. Tuttavia, applicando il clock gating, la potenza di leakage presenta una riduzione: si ipotizza che tale comportamento sia correlato ad una riduzione delle celle utilizzate.
\\
Per verificare ciò è stato effettuato un report di tipo cell.
\\
\begin{center}
	\begin{tabular}{|c|c|c|}
	\hline
	\multicolumn{3}{c}{Cell report - reset e ingressi modificati}\\
	\hline
	& No clock gating & Clock gating \\
	\hline
	Numero celle & 96 & 81 \\
	\hline
	 Area [um 2] & 244.72 & 243.66 \\
	\hline
	\end{tabular}	
\end{center}
\vspace{0.3cm} 
 L'ipotesi di riduzione del numero di celle è confermato, tuttavia tale risultato è in controtendenza con quanto atteso successivamente all'implementazione di clock gating: ci si aspetta un incremento dell'area totale dovuto all'inserimento della logica atta all'implementazione di tale tecnica.
 \\\\
Si ipotizza che, a causa della modifica apportata al file VHDL, il sintetizzatore, nel caso in cui non sia specificato di applicare il clock gating, interpreti la descrizione inserendo della logica aggiuntiva per verificare la condizione di if. Al contrario, applicando la direttiva \textbf{-gate\_clock}, la descrizione viene interpretata correttamente dal sintetizzatore.
\\
Il numero di celle risulta maggiore rispetto al caso in cui il clock gating viene applicato solamente ai registri REG\_A e REG\_B.
\end{document}
